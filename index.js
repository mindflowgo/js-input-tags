export default class t{constructor(t){let{tags:e,unique:i,drag:s,delimiter:a,maxTags:l,specialKeys:n,mouse:r,afterUpdate:h,afterEnter:d,inputId:g,listId:o,outputId:u,autocompleteList:c}=t,E={tagCnt:0,tags:[],unique:i||!1,drag:s||!1,dragTag:{fromId:null,toId:null},delimiter:a||",",maxTags:l,specialKeys:n||!1,mouse:r||!1,afterUpdate:h,afterEnter:d,searchItems:c||[],inputId:g,listID:o,listEl:null,inputEl:null,searchListEl:null,outputId:u||void 0};if(Object.assign(this,E),this.inputEl=document.getElementById(g),this.listEl=document.getElementById(o),"INPUT"!=this.inputEl.tagName||"UL"!=this.listEl.tagName)throw Error("TagsInput: NEED EXISTING input and list element: inputEl, listEl");this.searchItems.length>0&&(this.#a(g),this.inputEl.addEventListener("keyup",this.#b.bind(this))),this.listEl.classList.add("tagsList"),this.drag&&(this.listEl.addEventListener("dragstart",this.#c.bind(this)),this.listEl.addEventListener("dragover",this.#c.bind(this)),this.listEl.addEventListener("dragenter",this.#c.bind(this)),this.listEl.addEventListener("dragend",this.#c.bind(this))),this.inputEl.addEventListener(this.specialKeys?"keydown":"keyup",this.#d.bind(this)),this.specialKeys&&this.mouse&&this.inputEl.addEventListener("mousedown",this.#d.bind(this)),document.addEventListener(`__${this.listID}_`,this.#e.bind(this)),this.listEl.innerHTML="",e&&e.length>0&&e.forEach(t=>this.addTag(t,!0)),this.inputEl.focus()}#f(t=""){let e=document.getElementById(this.outputId);t&&this.inputEl.setAttribute("placeholder",t);let i=this.tags.filter(t=>""!==t).join(this.delimiter);e&&(e.value=i),this.afterUpdate&&this.afterUpdate(i,t)}#g(s){return s.replace(/[\u00A0-\u9999<>\&'"]/g,t=>"&#"+t.charCodeAt(0)+";")}#h(a,l=!1){return a.replace(/(['"])/g,t=>(l?"\\":"")+"&#"+t.charCodeAt(0)+";")}#i(n=!0){this.tags=[],document.querySelectorAll(`#${this.listID} LI`).forEach(t=>{t.dataset.item&&this.tags.push(t.dataset.item)}),n&&this.#f()}#d(r){let h=r.key||"";if(this.specialKeys){if(r.which<6){if(!this.mouse||document.activeElement.id!=this.inputEl.id||this.inputEl.value.length>0)return;r.preventDefault(),1==r.which?this.addTag("ClickLeft"):2==r.which?this.addTag("ClickMiddle"):3==r.which&&this.addTag("ClickRight");return}let d=["Control","Meta","Alt"],g={ArrowLeft:"←",ArrowUp:"↑",ArrowRight:"→",ArrowDown:"↓"};if(g[h]&&(h=g[h]),["Shift"].includes(h))return;if(0==r.target.value.length&&["Backspace","Enter","←","→","↑","↓","Escape","Tab","CapsLock","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"].includes(h)){r.preventDefault(),this.addTag(h),r.target.value="";return}if("Enter"==h)r.preventDefault();else{let o=r.target.value.split(",").filter(t=>""!==t.trim()),u=o.every(t=>d.includes(t)),c=o.includes(h);h.length>2?u&&!c&&d.includes(h)&&(r.target.value+=(r.target.value.length>0?",":"")+h):u&&r.target.value.length>0&&(r.preventDefault(),r.target.value+=","+h)}}"Enter"==h&&(this.addTag(r.target.value),r.target.value="",this.tags.length>0&&"function"==typeof this.afterEnter&&this.afterEnter(this.tags))}#e(E){let{action:p,tags:m,elementID:v}=E.detail;"add"==p?(this.addTag(m),this.inputEl.value="",this.inputEl.focus(),this.searchListEl&&(this.searchListEl.style.display="none")):"remove"==p&&this.removeTag(v),E.preventDefault()}#c(f){if("dragover"==f.type){f.preventDefault();return}if("LI"!=f.target.tagName){this.dragTag.toId=null;return}let L=f.target;if("dragstart"==f.type)this.dragTag.fromId=L.id,f.dataTransfer.effectAllowed="move",L.classList.add("tagsDragThis");else if("dragenter"==f.type)this.dragTag.toId=L.id,document.querySelectorAll(`#${this.listID} LI`).forEach(t=>t.classList.remove("tagsDragOver")),L.id!=this.dragTag.fromId&&L.classList.add("tagsDragOver");else if("dragend"==f.type){f.preventDefault(),document.querySelectorAll(`#${this.listID} LI`).forEach(t=>t.classList.remove("tagsDragOver"));let T=document.getElementById(this.dragTag.fromId);if(T.classList.remove("tagsDragThis"),this.dragTag.toId&&this.dragTag.toId!=this.dragTag.fromId){let I=document.getElementById(this.dragTag.toId).getClientRects()[0];if(Math.abs(f.clientX+window.scrollX-I.left)>100){console.log(` x DROP IGNORED: too far away tag on X-axis (${I.left},${I.top}) drop(${f.clientX+window.scrollX},${f.clientY})`);return}let y=T.cloneNode(!0);T.remove(),document.getElementById(this.dragTag.toId).insertAdjacentElement("beforebegin",y),this.#i()}}}destroy(){this.inputEl.removeEventListener(this.specialKeys?"keydown":"keyup",this.#d),document.removeEventListener(`__${this.listID}_`,this.#e),this.tags.length<1&&this.listEl.classList.remove("tagsList"),this.listEl.innerHTML=this.tags.map(t=>`<li>${this.#g(t)}</li>`).join(""),this.searchItems.length>0&&(this.inputEl.removeEventListener("keyup",this.#b),this.searchListEl&&this.searchListEl.remove()),this.drag&&(this.listEl.removeEventListener("dragstart",this.#c),this.listEl.removeEventListener("dragenter",this.#c),this.listEl.removeEventListener("dragover",this.#c),this.listEl.removeEventListener("dragend",this.#c)),this.inputEl=null,this.listEl=null,this.searchListEl=null}adjustOutput(t=[]){let e=document.getElementById(this.outputId);e&&(e.value=t.filter(t=>""!==t).join(this.delimiter))}getTags(){return this.tags}addTag(t,e=!1){this.#i(!1);let i="",s="";t.split(this.delimiter).forEach(t=>{if(!e&&this.maxTags&&this.tags.length>=this.maxTags)console.log(` x maxTags(${this.maxTags}) reached: ignoring tag '${t}'`),s="MaxTags Reached";else if(""!=(t=t.trim())&&(!this.unique||!this.tags.includes(t))){this.tags.push(t),this.tagCnt++;let a=this.listID+"_"+this.tagCnt;i+=`<li id='${a}' data-item='${this.#h(t)}' ${this.drag?"draggable='true' ":""}>${this.#g(t)} <span onclick="_tagAction('remove','${this.listID}','','${a}')">X</span></li>`}}),this.listEl.innerHTML+=i,(i||s)&&this.#f(s)}removeTag(t){let e=document.getElementById(t);e&&(e.remove(),this.#i())}toggleAutoComplete(t){this.searchListEl&&("none"==this.searchListEl.style.display?this.#b(null,t):this.searchListEl.style.display="none")}#a(D){let A=document.createElement("span"),$=document.getElementById(D);A.className="tagsAutocompleteList",$.parentNode.insertBefore(A,$),A.appendChild($);let b=this.listID+"_autocomplete",C=`<ul id='${b}' style='display: none'></ul>`;A.insertAdjacentHTML("beforeend",C),this.searchListEl=document.getElementById(b)}#b(w,_=""){let k=_||w.target.value.trim(),F=[];if(k.length>1){F=this.searchItems.filter(t=>-1!=t.toLowerCase().indexOf(k.toLowerCase()));let M=F.map(t=>`<li onclick="_tagAction('add','${this.listID}','${this.#h(t,!0)}')">${this.#g(t)}</li>`).join("");this.searchListEl.innerHTML=M}this.searchListEl.style.display=k.length>1&&F.length>0?"block":"none"}};function _tagAction(t,e,i=[],s=""){let a=new CustomEvent(`__${e}_`,{bubbles:!0,cancelable:!0,detail:{action:t,tags:i,elementID:s}});document.dispatchEvent(a)}window._tagAction=_tagAction;