export default class t{constructor(t){let{tags:e,unique:i,drag:s,delimiter:a,specialKeys:l,mouse:r,afterUpdate:n,inputId:h,listId:d,outputId:g,autocompleteList:o}=t,u={tagCnt:0,tags:[],unique:i||!1,drag:s||!1,dragTag:{fromId:null,toId:null},delimiter:a||",",specialKeys:l||!1,mouse:r||!1,afterUpdate:n||void 0,searchItems:o||[],listID:d,listEl:null,inputEl:null,searchListEl:null,outputId:g||void 0};if(Object.assign(this,u),this.inputEl=document.getElementById(h),this.listEl=document.getElementById(d),"INPUT"!=this.inputEl.tagName||"UL"!=this.listEl.tagName)throw Error("TagsInput: NEED EXISTING input and list element: inputEl, listEl");this.searchItems.length>0&&(this.#a(h),this.inputEl.addEventListener("keyup",this.#b.bind(this))),this.listEl.classList.add("tagsList"),this.drag&&(this.listEl.addEventListener("dragstart",this.#c.bind(this)),this.listEl.addEventListener("dragover",this.#c.bind(this)),this.listEl.addEventListener("dragenter",this.#c.bind(this)),this.listEl.addEventListener("dragend",this.#c.bind(this))),this.inputEl.addEventListener(this.specialKeys?"keydown":"keyup",this.#d.bind(this)),this.specialKeys&&this.mouse&&this.inputEl.addEventListener("mousedown",this.#d.bind(this)),document.addEventListener(`__${this.listID}_`,this.#e.bind(this)),e&&e.length>0&&e.forEach(t=>this.addTag(t))}#f(){let t=document.getElementById(this.outputId),e=this.tags.filter(t=>""!==t).join(this.delimiter);t&&(t.value=e),this.afterUpdate&&this.afterUpdate(e)}#g(i){return i.replace(/[\u00A0-\u9999<>\&'"]/g,t=>"&#"+t.charCodeAt(0)+";")}#h(s,a=!1){return s.replace(/(['"])/g,t=>(a?"\\":"")+"&#"+t.charCodeAt(0)+";")}#i(){this.tags=[],document.querySelectorAll(`#${this.listID} LI`).forEach(t=>{t.dataset.item&&this.tags.push(t.dataset.item)}),this.#f()}#d(l){let r=l.key||"";if(this.specialKeys){if(l.which<6){if(!this.mouse||document.activeElement.id!=this.inputEl.id||this.inputEl.value.length>0)return;l.preventDefault(),1==l.which?this.addTag("ClickLeft"):2==l.which?this.addTag("ClickMiddle"):3==l.which&&this.addTag("ClickRight");return}let n=["Control","Meta","Alt"],h={ArrowLeft:"←",ArrowUp:"↑",ArrowRight:"→",ArrowDown:"↓"};if(h[r]&&(r=h[r]),["Shift"].includes(r))return;if(0==l.target.value.length&&["Backspace","Enter","←","→","↑","↓","Escape","Tab","CapsLock","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"].includes(r)){l.preventDefault(),this.addTag(r),l.target.value="";return}if("Enter"==r)l.preventDefault();else{let d=l.target.value.split(",").filter(t=>""!==t.trim()),g=d.every(t=>n.includes(t)),o=d.includes(r);r.length>2?g&&!o&&n.includes(r)&&(l.target.value+=(l.target.value.length>0?",":"")+r):g&&l.target.value.length>0&&(l.preventDefault(),l.target.value+=","+r)}}"Enter"==r&&(this.addTag(l.target.value),l.target.value="")}#e(u){let{action:c,tags:E,elementID:p}=u.detail;"add"==c?(this.addTag(E),this.inputEl.value="",this.inputEl.focus(),this.searchListEl&&(this.searchListEl.style.display="none")):"remove"==c&&this.removeTag(p),u.preventDefault()}#c(m){if("dragover"==m.type){m.preventDefault();return}if("LI"!=m.target.tagName){this.dragTag.toId=null;return}let v=m.target;if("dragstart"==m.type)this.dragTag.fromId=v.id,m.dataTransfer.effectAllowed="move",v.classList.add("tagsDragThis");else if("dragenter"==m.type)this.dragTag.toId=v.id,document.querySelectorAll(`#${this.listID} LI`).forEach(t=>t.classList.remove("tagsDragOver")),v.id!=this.dragTag.fromId&&v.classList.add("tagsDragOver");else if("dragend"==m.type){m.preventDefault(),document.querySelectorAll(`#${this.listID} LI`).forEach(t=>t.classList.remove("tagsDragOver"));let L=document.getElementById(this.dragTag.fromId);if(L.classList.remove("tagsDragThis"),this.dragTag.toId&&m.offsetY>-30&&m.offsetY<90){let f=L.cloneNode(!0);L.remove(),document.getElementById(this.dragTag.toId).insertAdjacentElement("beforebegin",f),this.#i()}}}destroy(){this.inputEl.removeEventListener(this.specialKeys?"keydown":"keyup",this.#d),document.removeEventListener(`__${this.listID}_`,this.#e),this.listEl.classList.remove("tagsList"),this.listEl.innerHTML="",this.searchItems.length>0&&(this.inputEl.removeEventListener("keyup",this.#b),this.searchListEl&&this.searchListEl.remove()),this.drag&&(this.listEl.removeEventListener("dragstart",this.#c),this.listEl.removeEventListener("dragenter",this.#c),this.listEl.removeEventListener("dragover",this.#c),this.listEl.removeEventListener("dragend",this.#c)),this.inputEl=null,this.listEl=null,this.searchListEl=null}adjustOutput(t=[]){let e=document.getElementById(this.outputId);e&&(e.value=t.filter(t=>""!==t).join(this.delimiter))}getTags(){return this.tags}addTag(t){let e="";t.split(this.delimiter).forEach(i=>{if(t=i.trim(),""!=i&&(!this.unique||!this.tags.includes(i))){this.tags.push(i),this.tagCnt++;let s=this.listID+"_"+this.tagCnt;e+=`<li id='${s}' data-item='${this.#h(i)}' ${this.drag?"draggable='true' ":""}>${this.#g(i)} <span onclick="_tagAction('remove','${this.listID}','','${s}')">X</span></li>`}}),this.listEl.innerHTML+=e,this.#f()}removeTag(t){let e=document.getElementById(t);console.log(`[removeTag] elementID(${t})`,e),e&&(e.remove(),this.#i())}toggleAutoComplete(t){this.searchListEl&&("none"==this.searchListEl.style.display?this.#b(null,t):this.searchListEl.style.display="none")}#a(I){let T=document.createElement("span"),y=document.getElementById(I);T.className="tagsAutocompleteList",y.parentNode.insertBefore(T,y),T.appendChild(y);let D=this.listID+"_autocomplete",A=`<ul id='${D}' style='display: none'></ul>`;T.insertAdjacentHTML("beforeend",A),this.searchListEl=document.getElementById(D)}#b($,b=""){let C=b||$.target.value.trim(),w=[];if(C.length>1){w=this.searchItems.filter(t=>-1!=t.toLowerCase().indexOf(C.toLowerCase()));let k=w.map(t=>`<li onclick="_tagAction('add','${this.listID}','${this.#h(t,!0)}')">${this.#g(t)}</li>`).join("");this.searchListEl.innerHTML=k}this.searchListEl.style.display=C.length>1&&w.length>0?"block":"none"}};function _tagAction(t,e,i=[],s=""){let a=new CustomEvent(`__${e}_`,{bubbles:!0,cancelable:!0,detail:{action:t,tags:i,elementID:s}});document.dispatchEvent(a)}window._tagAction=_tagAction;